<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AresNyX - Premium Boxer Shorts Shop</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    
    <style>
    /* ===== CRITICAL CSS - OPTIMIZOVANO ===== */
    :root {
        --primary-dark: #121212;
        --accent-gold: #D4AF37;
        --accent-hover: #F4C44D;
        --success: #27AE60;
        --danger: #E74C3C;
        --gray-light: #F8F9FA;
        --gray-medium: #E9ECEF;
        --text-dark: #2C3E50;
        --shadow: 0 10px 30px rgba(0,0,0,0.1);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
        font-family: 'Montserrat', system-ui, -apple-system, sans-serif;
        background: #fff; color: var(--text-dark); line-height: 1.6;
        display: flex; flex-direction: column; 
        min-height: 100vh;
        /* SKRIVANJE SCROLL BARA PRILIKOM OTVARANJA MODALA/KORPE */
        overflow-x: hidden;
    }
    
    /* HEADER */
    .header { 
        background: var(--primary-dark); padding: 1rem 2rem; 
        position: sticky; top: 0; z-index: 1000; 
        box-shadow: 0 2px 20px rgba(0,0,0,0.3);
    }
    .navbar { display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; }
    .logo { font-size: 2rem; font-weight: 700; color: var(--accent-gold); text-decoration: none; letter-spacing: 3px; }
    .cart-icon { position: relative; cursor: pointer; padding: 0.5rem 1rem; color: #fff; font-size: 1.1rem; transition: var(--transition); }
    .cart-icon:hover { border: 2px solid var(--accent-gold); color: var(--accent-gold); border-radius: 8px; }
    .cart-count { position: absolute; top: -8px; right: -8px; background: var(--danger); color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.8em; font-weight: 600; }
    
    /* PRODUCTS GRID */
    .products-section { padding: 3rem 2rem; max-width: 1400px; margin: 0 auto; flex: 1; }
    .products-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    .product-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); cursor: pointer; transition: var(--transition); }
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.15); }
    .product-badge { position: absolute; top: 1rem; left: 1rem; background: var(--success); color: white; padding: 0.3rem 0.8rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600; z-index: 2; }
    .product-badge.premium { background: var(--accent-gold); color: var(--primary-dark); }
    .product-badge.new { background: var(--danger); }
    .product-image { width: 100%; height: 200px; object-fit: cover; background: #f7f7f7; }
    .product-info { padding: 1.2rem; }
    .product-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; }
    .product-material { color: #666; font-size: 0.9rem; margin-bottom: 0.8rem; }
    .product-price { font-size: 1.2rem; font-weight: 700; }
    
    @media (min-width: 576px) { .products-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (min-width: 992px) { .products-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 768px) { .header { padding: 1rem; } .products-section { padding: 2rem 1rem; } }
    
    /* FOOTER */
    .footer { background: var(--primary-dark); color: white; padding: 3rem 2rem 2rem; margin-top: auto; }
    /* ... (ostatak footer stilova) ... */
    
    /* ===== MODAL - POVEĆANA VISINA ===== */
    .modal-overlay { 
        display: none; position: fixed; top: 0; left: 0; 
        width: 100%; height: 100%; background: rgba(0,0,0,0.9); 
        z-index: 2000; backdrop-filter: blur(5px); 
    }
    .modal-container { 
        position: absolute; top: 50%; left: 50%; 
        transform: translate(-50%, -50%); 
        background: white; border-radius: 16px; 
        width: 90%; max-width: 700px;
        max-height: 95vh; /* Povećana visina */
        overflow-y: auto; 
    }
    /* ... (ostatak modal stilova) ... */
    
    /* ===== KORPA SIDEBAR - POVEĆANA VISINA ===== */
    .cart-sidebar { 
        position: fixed; top: 0; right: -400px; width: 400px; 
        height: 100vh; /* Maksimalna visina ekrana */
        background: white; box-shadow: -5px 0 25px rgba(0,0,0,0.1); 
        transition: var(--transition); z-index: 1500; display: flex; flex-direction: column; 
    }
    @media (max-width: 450px) { .cart-sidebar { width: 100%; right: -100%; } }
    .cart-sidebar.active { right: 0; }
    /* ... (ostatak cart stilova) ... */

    /* Dugme za Isprazni Korpu je sada u Footeru Korpe, pre Checkouta */
    .cart-footer { 
        padding: 1.5rem; border-top: 1px solid var(--gray-medium); 
        background: var(--gray-light); 
        display: flex; flex-direction: column; /* Omogućava da dugmad budu jedno ispod drugog */
    }
    .cart-actions-footer { /* NOVI WRAPPER za dugme Isprazni */
        margin-bottom: 1rem;
    }
    .clear-cart-btn { 
        width: 100%; /* Da zauzme celu širinu */
        background: var(--danger); color: white; 
        border: none; padding: 0.8rem; border-radius: 6px; 
        cursor: pointer; transition: var(--transition); 
        font-weight: 600; display: flex; align-items: center; 
        justify-content: center; gap: 0.5rem; 
        margin-bottom: 0.5rem; /* Razmak od checkout dugmeta */
    }
    .clear-cart-btn:hover { background: #c0392b; transform: translateY(-2px); }
    /* ... (ostatak stilova) ... */
    </style>
    
    <noscript>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    </noscript>
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <a href="index.html" class="logo">ARESNYX</a>
            <div class="cart-icon" onclick="shop.openCart()"> <i class="fas fa-shopping-bag"></i>
                <span class="cart-count" id="cartCount">0</span>
            </div>
        </nav>
    </header>

    <main class="main-content">
        <section class="products-section">
            <div class="products-grid" id="productsGrid">
                </div>
        </section>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-logo">ARESNYX</div>
            <p class="footer-tagline">Premium kvalitet. Izuzetan komfor. Vaš stil.</p>
            
            <div class="footer-links">
                <a href="index.html" class="footer-link">Početna</a>
                <a href="shop.html" class="footer-link">Shop</a>
                <a href="#" class="footer-link">O nama</a>
                <a href="#" class="footer-link">Kontakt</a>
            </div>
            
            <div class="footer-social">
                <a href="#" class="social-icon"><i class="fab fa-instagram"></i></a>
                <a href="#" class="social-icon"><i class="fab fa-facebook-f"></i></a>
                <a href="#" class="social-icon"><i class="fab fa-tiktok"></i></a>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2024 AresNyX. Sva prava zadržana.</p>
            </div>
        </div>
    </footer>

    <div class="modal-overlay" id="productModal">
        <div class="modal-container">
            <button class="modal-close" onclick="shop.closeModal()">×</button>
            <div class="modal-content">
                <div class="modal-gallery">
                    <img class="modal-main-image" id="modalMainImage" src="" alt="Detaljni prikaz bokserica" loading="lazy">
                    <div class="slider-nav">
                        <button onclick="shop.prevImage()"><i class="fas fa-chevron-left"></i> Prethodna</button>
                        <button onclick="shop.nextImage()">Sledeća <i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                
                <div class="modal-details">
                    <h2 id="modalTitle"></h2>
                    <p class="modal-material" id="modalMaterial"></p>
                    <p class="modalPrice" id="modalPrice"></p>
                    
                    <div class="size-section">
                        <h3>Odaberite veličinu:</h3>
                        <div class="size-selector" id="sizeSelector"></div>
                        <div class="size-info" onclick="shop.toggleSizeTable()">
                            <i class="fas fa-ruler"></i>
                            <span>Tabela veličina</span>
                        </div>
                    </div>

                    <div class="size-table-container" id="sizeTable" style="display: none;">
                        <h4><i class="fas fa-table"></i> Tabela veličina (cm)</h4>
                        <table class="size-table">
                            <thead>
                                <tr><th>Veličina</th><th>Struk</th><th>Dužina</th><th>Širina nogavice</th></tr>
                            </thead>
                            <tbody>
                                <tr><td><strong>M</strong></td><td>72-76</td><td>28</td><td>24</td></tr>
                                <tr><td><strong>L</strong></td><td>77-81</td><td>29</td><td>25</td></tr>
                                <tr><td><strong>XL</strong></td><td>82-86</td><td>30</td><td>26</td></tr>
                                <tr><td><strong>XXL</strong></td><td>87-91</td><td>31</td><td>27</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="quantity-section">
                        <h3>Količina:</h3>
                        <div class="quantity-selector">
                            <button class="qty-btn" onclick="shop.changeQuantity(-1)">-</button>
                            <span class="qty-display" id="modalQty">1</span>
                            <button class="qty-btn" onclick="shop.changeQuantity(1)">+</button>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="add-to-cart-btn" onclick="shop.addToCartFromModal(event)">
                            <i class="fas fa-shopping-cart"></i> Dodaj u Korpu
                        </button>
                        <button class="continue-shopping" onclick="shop.closeModal()">
                            Nastavi kupovinu
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <h3>Vaša Korpa</h3>
            <button class="modal-close" onclick="shop.closeCart()">×</button> </div>
        <div class="cart-items" id="cartItems">
            <div class="empty-cart" id="emptyCart">
                <i class="fas fa-shopping-bag"></i>
                <p>Vaša korpa je prazna</p>
            </div>
        </div>
        
        <div class="cart-footer" id="cartFooter" style="display: none;">
            <div class="cart-actions-footer">
                 <button class="clear-cart-btn">
                    <i class="fas fa-trash"></i> Isprazni Korpu
                </button>
            </div>

            <div class="cart-totals">
                <div class="cart-total-row"><span>Međuzbir:</span><span id="cartSubtotal">0 RSD</span></div>
                <div class="cart-total-row"><span>Poštarina:</span><span id="cartShipping">0 RSD</span></div>
                <div class="cart-total-row"><span>Popust:</span><span id="cartDiscount">0 RSD</span></div>
                <div class="cart-total-row final"><span>Ukupno:</span><span id="cartTotal">0 RSD</span></div>
            </div>
            <button class="checkout-btn" onclick="shop.checkout()"><i class="fas fa-lock"></i> Završi Kupovinu</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
    // ===== FINALNO REŠENJE SA POBOLJŠANOM DELEGACIJOM I RENDEROVANJEM =====
    
    class AresNyXShop {
        constructor() {
            this.cart = JSON.parse(localStorage.getItem('cart')) || [];
            this.products = [];
            this.currentProduct = null;
            this.currentSize = 'M';
            this.currentQuantity = 1;
            this.currentImageIndex = 0;
            this.init();
        }

        init() {
            this.loadProducts();
            this.updateCartCount();
            this.renderCart();
            this.setupCartListeners(); // POZIV NOVE METODE ZA DELEGACIJU
        }
        
        // NOVO: Delegacija događaja za elemente korpe
        setupCartListeners() {
            const cartItems = document.getElementById('cartItems');
            const cartFooter = document.getElementById('cartFooter');
            
            // 1. Delegacija za dinamičke stavke korpe (X dugme, +/- dugmad)
            cartItems.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;

                const action = target.getAttribute('data-action');
                const index = parseInt(target.getAttribute('data-index'));

                if (action === 'remove') {
                    this.removeCartItem(index);
                } else if (action === 'qty-down') {
                    this.updateCartItem(index, -1);
                } else if (action === 'qty-up') {
                    this.updateCartItem(index, 1);
                }
            });

            // 2. Clear Cart dugme (fiksno dugme unutar footer-a)
            const clearBtn = cartFooter.querySelector('.clear-cart-btn');
            if(clearBtn) {
                clearBtn.addEventListener('click', () => {
                    this.clearCart();
                });
            }
        }

        loadProducts() {
            this.products = [
                { id: 1, name: "Classic Pamuk", material: "100% Organski Pamuk", price: 1300, category: "pamuk", images: ["images/pamuk-1.jpg", "images/pamuk-2.jpg"], badge: "BESTSELLER" },
                { id: 2, name: "Premium Lan", material: "100% Premium Lan", price: 1500, category: "lan", images: ["images/lan-1.jpg", "images/lan-2.jpg"], badge: "PREMIUM" },
                { id: 3, name: "Elegant Svila", material: "100% Prirodna Svila", price: 1800, category: "svila", images: ["images/svila-1.jpg", "images/svila-2.jpg"], badge: "LUXURY" },
                { id: 4, name: "Night Black", material: "100% Premium Pamuk", price: 1300, category: "pamuk", images: ["images/crna-1.jpg", "images/crna-2.jpg"], badge: "POPULAR" },
                { id: 5, name: "Pure White", material: "100% Organski Pamuk", price: 1300, category: "pamuk", images: ["images/bela-1.jpg", "images/bela-2.jpg"], badge: "CLASSIC" },
                { id: 6, name: "Navy Stripes", material: "100% Premium Pamuk", price: 1400, category: "pamuk", images: ["images/navy-1.jpg", "images/navy-2.jpg"], badge: "TRENDING" },
                { id: 7, name: "Dark Grey", material: "100% Premium Pamuk", price: 1300, category: "pamuk", images: ["images/siva-1.jpg", "images/siva-2.jpg"], badge: "ESSENTIAL" },
                { id: 8, name: "Blue Stripes", material: "100% Premium Pamuk", price: 1400, category: "pamuk", images: ["images/plava-1.jpg", "images/plava-2.jpg"], badge: "NEW" },
                { id: 9, name: "Charcoal Black", material: "100% Premium Pamuk", price: 1350, category: "pamuk", images: ["images/charcoal-1.jpg", "images/charcoal-2.jpg"], badge: "PREMIUM" },
                { id: 10, name: "Bamboo Blend", material: "70% Bambus, 30% Pamuk", price: 1600, category: "lan", images: ["images/bambus-1.jpg", "images/bambus-2.jpg"], badge: "ECO" },
                { id: 11, name: "Sport Grey", material: "95% Pamuk, 5% Elastan", price: 1450, category: "pamuk", images: ["images/sport-1.jpg", "images/sport-2.jpg"], badge: "SPORT" },
                { id: 12, name: "Midnight Blue", material: "100% Premium Pamuk", price: 1400, category: "pamuk", images: ["images/midnight-1.jpg", "images/midnight-2.jpg"], badge: "EXCLUSIVE" }
            ];
            this.renderProducts();
        }

        renderProducts() {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = this.products.map(product => `
                <div class="product-card fade-in" onclick="shop.openProductModal(${product.id})">
                    ${product.badge ? `<div class="product-badge ${product.badge.toLowerCase()}">${product.badge}</div>` : ''}
                    <img src="${product.images[0]}" alt="AresNyX Bokserice: ${product.name}" class="product-image" loading="lazy">
                    <div class="product-info">
                        <h3 class="product-title">${product.name}</h3>
                        <p class="product-material">${product.material}</p>
                        <p class="product-price">${product.price} RSD</p>
                    </div>
                </div>
            `).join('');
        }

        openProductModal(productId) {
            this.currentProduct = this.products.find(p => p.id === productId);
            if (!this.currentProduct) return;

            // Reset stanja modala
            this.currentSize = 'M';
            this.currentQuantity = 1;
            this.currentImageIndex = 0;

            document.getElementById('modalTitle').textContent = this.currentProduct.name;
            document.getElementById('modalMaterial').textContent = this.currentProduct.material;
            document.getElementById('modalPrice').textContent = `${this.currentProduct.price} RSD`;
            document.getElementById('modalQty').textContent = '1';

            this.updateModalImage();

            const sizeSelector = document.getElementById('sizeSelector');
            sizeSelector.innerHTML = ['M', 'L', 'XL', 'XXL'].map(size => `
                <div class="size-option ${size === 'M' ? 'selected' : ''}" onclick="shop.selectSize(event, '${size}')">${size}</div>
            `).join('');

            document.getElementById('sizeTable').style.display = 'none';
            document.getElementById('productModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Osiguravamo da dugme za korpu bude u inicijalnom stanju
            const btn = document.querySelector('.add-to-cart-btn');
            btn.innerHTML = '<i class="fas fa-shopping-cart"></i> Dodaj u Korpu';
            btn.style.background = 'var(--primary-dark)';
            btn.disabled = false;
        }

        updateModalImage() {
            if (!this.currentProduct) return;
            document.getElementById('modalMainImage').src = this.currentProduct.images[this.currentImageIndex];
        }

        selectSize(event, size) {
            this.currentSize = size;
            document.querySelectorAll('.size-option').forEach(opt => opt.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        changeQuantity(change) {
            this.currentQuantity = Math.max(1, this.currentQuantity + change);
            document.getElementById('modalQty').textContent = this.currentQuantity;
        }

        prevImage() {
            if (!this.currentProduct) return;
            this.currentImageIndex = (this.currentImageIndex - 1 + this.currentProduct.images.length) % this.currentProduct.images.length;
            this.updateModalImage();
        }

        nextImage() {
            if (!this.currentProduct) return;
            this.currentImageIndex = (this.currentImageIndex + 1) % this.currentProduct.images.length;
            this.updateModalImage();
        }

        addToCartFromModal(event) {
            if (!this.currentProduct || !this.currentSize) return;
            
            const btn = event.currentTarget;
            if (btn.disabled) return;
            btn.disabled = true;

            // INSTANT FEEDBACK NA DUGMETU
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Dodato!';
            btn.style.background = 'var(--success)';
            
            // 1. INSTANT DODAVANJE U KORPU
            this.addToCart(this.currentProduct.id, this.currentSize, this.currentQuantity);
            
            // 2. TRENUTNO OSVEŽAVANJE I RENDER (REŠAVA PROBLEM NEVIDLJIVIH STAVKI)
            this.updateCartCount();
            this.renderCart(); 
            
            // 3. INSTANT TOAST
            this.showToast(`${this.currentProduct.name} (${this.currentSize}) je dodat u korpu!`);
            
            // 4. BRZO ZATVARANJE MODALA
            setTimeout(() => {
                this.closeModal();
                btn.innerHTML = originalText;
                btn.style.background = 'var(--primary-dark)';
                btn.disabled = false;
            }, 500); 
        }

        addToCart(productId, size, quantity) {
            const product = this.products.find(p => p.id === productId);
            const existingItem = this.cart.find(item => item.productId === productId && item.size === size);

            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                this.cart.push({ 
                    productId, 
                    size, 
                    quantity, 
                    name: product.name, 
                    price: product.price, 
                    image: product.images[0] 
                });
            }

            this.saveCart();
        }

        updateCartCount() {
            const totalItems = this.cart.reduce((sum, item) => sum + item.quantity, 0);
            const cartCount = document.getElementById('cartCount');
            cartCount.textContent = totalItems;
            
            cartCount.classList.remove('quick-pulse'); 
            void cartCount.offsetWidth;
            cartCount.classList.add('quick-pulse');
        }

        renderCart() {
            const cartItemsContainer = document.getElementById('cartItems');
            const cartFooter = document.getElementById('cartFooter');
            const clearCartButton = cartFooter.querySelector('.clear-cart-btn');

            if (this.cart.length === 0) {
                cartItemsContainer.innerHTML = `
                    <div class="empty-cart" id="emptyCart">
                        <i class="fas fa-shopping-bag"></i>
                        <p>Vaša korpa je prazna</p>
                    </div>
                `;
                cartFooter.style.display = 'none';
                return;
            }
            
            // Uvek prikaži footer ako ima stavki
            cartFooter.style.display = 'flex';

            // GENERISANJE STAVKI
            cartItemsContainer.innerHTML = this.cart.map((item, index) => `
                <div class="cart-item" data-index="${index}">
                    <button class="cart-item-remove" data-action="remove" data-index="${index}" title="Ukloni proizvod">×</button>
                    <img src="${item.image}" alt="Miniatura ${item.name} bokserica veličine ${item.size}" class="cart-item-image" loading="lazy">
                    <div class="cart-item-details">
                        <div class="cart-item-title">${item.name}</div>
                        <div class="cart-item-size">Veličina: ${item.size}</div>
                        <div class="cart-item-controls">
                            <button class="cart-item-qty-btn" data-action="qty-down" data-index="${index}">-</button>
                            <span class="cart-item-qty">${item.quantity}</span>
                            <button class="cart-item-qty-btn" data-action="qty-up" data-index="${index}">+</button>
                            <span class="cart-item-price">${item.price * item.quantity} RSD</span>
                        </div>
                    </div>
                </div>
            `).join('');

            this.updateCartTotals();
        }
        
        // ... (updateCartItem, updateCartItemDisplay, updateCartTotals ostaju iste) ...

        removeCartItem(index) {
            // INSTANT UKLANJANJE
            const itemName = this.cart[index].name;
            this.cart.splice(index, 1);
            
            this.saveCart();
            this.updateCartCount();
            this.renderCart(); // TRENUTNO RENDERUJE NAKON UKLANJANJA (REŠAVA PROBLEM 1)
            
            this.showToast(`"${itemName}" je uklonjen iz korpe`);
        }

        // ... (updateCartTotals ostaje ista) ...

        clearCart() {
            if (this.cart.length === 0) {
                this.showToast("Korpa je već prazna!");
                return;
            }
            
            if (confirm("Da li ste sigurni da želite da ispraznite korpu? Ova akcija se ne može poništiti.")) {
                this.cart = [];
                this.saveCart();
                this.updateCartCount();
                this.renderCart(); // TRENUTNO RENDERUJE NAKON PRAŽNJENJA (REŠAVA PROBLEM 1)
                this.showToast("Korpa je ispražnjena!");
            }
        }
        
        // NOVE EKPLICITNE FUNKCIJE ZA UPRAVLJANJE SIDEBAROM
        openCart() {
             document.getElementById('cartSidebar').classList.add('active');
             document.body.style.overflow = 'hidden';
        }

        closeCart() {
             document.getElementById('cartSidebar').classList.remove('active');
             document.body.style.overflow = 'auto';
        }

        closeModal() {
            document.getElementById('productModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        checkout() {
             if (this.cart.length === 0) {
                this.showToast("Korpa je prazna! Dodajte proizvode pre završetka kupovine.");
                return;
            }
            
            const subtotal = this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const totalItems = this.cart.reduce((sum, item) => sum + item.quantity, 0);
            const shipping = totalItems >= 5 ? 0 : 400;
            const discount = totalItems >= 7 ? Math.round(subtotal * 0.1) : 0;
            const finalTotal = subtotal + shipping - discount;
            
            this.showToast(`Porudžbina uspešna! Ukupno za plaćanje: ${finalTotal} RSD. Hvala na poverenju!`);
            
            this.cart = [];
            this.saveCart();
            this.updateCartCount();
            this.renderCart();
            
            // Zatvaranje sidebara je sada sigurnije
            setTimeout(() => {
                this.closeCart();
            }, 800);
        }

        // ... (showToast, saveCart ostaju iste) ...
    }

    // Initialize shop
    const shop = new AresNyXShop();

    // Global functions (sada samo wrapper-i za pozive unutar klase)
    function closeModal() { shop.closeModal(); }
    function changeQuantity(change) { shop.changeQuantity(change); }
    function addToCartFromModal(event) { shop.addToCartFromModal(event); } 
    function prevImage() { shop.prevImage(); }
    function nextImage() { shop.nextImage(); }
    function toggleSizeTable() { 
        const table = document.getElementById('sizeTable');
        table.style.display = table.style.display === 'none' ? 'block' : 'none';
    }


    // Event listeners
    document.addEventListener('click', (e) => {
        const cartSidebar = document.getElementById('cartSidebar');
        const cartIcon = document.querySelector('.cart-icon');
        const modal = document.getElementById('productModal');
        
        // ZATVARANJE KORPE NA KLIK IZNAD OVERLAY-A
        if (cartSidebar.classList.contains('active') && !cartSidebar.contains(e.target) && !cartIcon.contains(e.target)) {
            shop.closeCart();
        }
        
        // ZATVARANJE MODALA NA KLIK NA OVERLAY
        if (modal.style.display === 'block' && e.target === modal) {
            shop.closeModal();
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            shop.closeModal();
            shop.closeCart();
        }
    });

    // Fallback za font awesome
    if (!window.FontAwesome) {
        const fa = document.createElement('link');
        fa.rel = 'stylesheet';
        fa.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';
        document.head.appendChild(fa);
    }
    </script>
</body>
</html>
                                                    const totalItems = this.cart.reduce((sum, item) => sum + item.quantit
